# CLAUDE.md

## 📋 指示の優先度レベル

**YOU MUST**: 以下の5段階の指示レベルを使用して、要件の重要度を明確に示してください。コンテキストが長くなると重要な指示が無視されることを防ぐため、適切なレベルの強調表現を使用してください。

| レベル | 表現 | 用途 | 説明 | 使用例 |
|:---:|:---|:---|:---|:---|
| **1** | `**CRITICAL**` | システム全体に影響する最重要事項 | 違反するとシステム障害やセキュリティ問題が発生 | セキュリティ設定、本番環境の保護 |
| **2** | `**IMPORTANT**` | プロジェクト品質に直結する重要事項 | 違反すると品質低下やメンテナンス困難が発生 | アーキテクチャ原則、データベース設計 |
| **3** | `**YOU MUST**` | 必須の実装要件・手順 | 必ず従うべき具体的な行動指針 | コーディング規約、テスト実行、手順遵守 |
| **4** | `**RECOMMENDED**` | ベストプラクティス・推奨事項 | 従うことで品質向上が期待される | コードフォーマット、リント実行 |
| **5** | `**NOTE**` | 補助的な情報・ヒント | 追加の知識や選択肢として提供 | 参考ドキュメント、代替手法 |

### 使用ガイドライン
- **YOU MUST**: すべての指示は肯定的な表現で記述してください。
- **YOU MUST**: 段階的な重要度で適切なレベルを選択してください。
- **YOU MUST**: ドキュメント（.md）でのみ使用し、コードには使用しないでください。

## 🚨 対話言語

**IMPORTANT**: **YOU MUST** Claude Code とのすべてのやり取りにおいて、レスポンスは必ず日本語で返答してください。これには以下を含みますが、コード自体とコマンドは英語のまま維持してください。
- エラーメッセージの説明
- 実装内容の説明
- 質問への回答
- 進捗状況の報告
- コードの変更内容の説明

## 🏛️ アーキテクチャ

**YOU MUST**: 本プロジェクトはドメイン駆動設計（DDD）の原則に従っています。プロジェクト全体でDDDアーキテクチャパターンを一貫して適用してください。

## 開発ガイドライン

### 実装の原則
**IMPORTANT**: 以下の実装方針を徹底してください。
- **完全性**:
    - **YOU MUST**: 機能は、部分的な実装や未完成の状態ではなく、最初から最後まで完全に動作する状態で実装してください。
    - **YOU MUST**: 実際のデータソース（API、データベース、設定ファイルなど）と統合し、実用的なコードを提供してください。
- **コード品質**:
    - **YOU MUST**: DRY原則とSOLID原則を遵守し、重複を排除し、責務を分離してください。
    - **YOU MUST**: 意図が明確に伝わる命名規則（関数名、変数名）を採用してください。
    - **YOU MUST**: 関数は小さく、単一の責務に集中させ、テスト可能な設計を心がけてください。
    - **YOU MUST**: 未使用のコード、フィールド、メソッドは実装しないでください。
- **デバッグとトレーサビリティ**:
    - **YOU MUST**: ログとトレースを通じて、実装した機能の動作を追跡・デバッグ可能にしてください。

### Rust ベストプラクティス
**YOU MUST**: 以下のRustベストプラクティスを厳守してください。
- **モジュール構造**: 
    - **CRITICAL**: すべてのモジュール宣言は`src/lib.rs`に集約してください。
    - **YOU MUST**: 薄いモジュールファイル（`pub mod`宣言のみを含むファイル）は作成せず、`src/lib.rs`で直接宣言してください。
    - **YOU MUST**: `pub use`による再エクスポートも`src/lib.rs`内のモジュール定義に含めてください。
    - **RECOMMENDED**: モジュール階層はコメントで明確に区分してください（例：`// Domain Layer`）。
- **エラーハンドリング**: `thiserror`を活用し、構造化された`Result`パターンを一貫して使用してください。
- **非同期処理**: Tokioランタイムを基本とし、`async/await`を適切に使用してください。
- **型安全性**: 値オブジェクトを利用してプリミティブ型をラップし、コンパイル時の型安全性を高めてください。

## 📝 コミットルール

### Conventional Commits
**CRITICAL**: 本プロジェクトでは[Conventional Commits](https://www.conventionalcommits.org/)仕様に従います。すべてのコミットメッセージは以下の規則を遵守してください。

#### コミットメッセージ形式
```
<type>[optional scope]: <description>

[optional body]

[optional footer(s)]
```

#### コミットタイプ
**YOU MUST**: 以下の定義されたコミットタイプを使用してください。

| タイプ | 説明 | 使用例 |
|:---:|:---|:---|
| `feat` | 新機能の追加 | `feat: ユーザー認証機能を実装` |
| `fix` | バグ修正 | `fix: ログイン時のエラーハンドリングを修正` |
| `docs` | ドキュメントのみの変更 | `docs: READMEにインストール手順を追加` |
| `style` | コードの意味に影響しない変更（空白、フォーマット等） | `style: コードフォーマットを統一` |
| `refactor` | バグ修正や機能追加を含まないコード変更 | `refactor: 認証ロジックを別モジュールに分離` |
| `perf` | パフォーマンスを向上させるコード変更 | `perf: データベースクエリを最適化` |
| `test` | テストの追加や修正 | `test: ユーザー登録の統合テストを追加` |
| `chore` | ビルドプロセスや補助ツールの変更 | `chore: 依存関係を更新` |
| `ci` | CI設定ファイルとスクリプトの変更 | `ci: GitHub Actionsワークフローを追加` |
| `build` | ビルドシステムや外部依存関係に影響する変更 | `build: Cargo.tomlの設定を更新` |

#### コミットメッセージのガイドライン
**YOU MUST**: 以下のガイドラインに従ってください。
- **言語**: すべてのコミットメッセージは日本語で記述してください（初回の `first commit` を除く）
- **簡潔性**: description は50文字以内で簡潔に記述してください
- **現在形**: 動詞は現在形を使用してください（「追加した」ではなく「追加」）
- **詳細説明**: 必要に応じてbodyに詳細な説明を記述してください
- **Issue参照**: 関連するIssueがある場合はfooterに記載してください

#### コミットメッセージの例
```
feat: ユーザープロフィール編集機能を追加

- プロフィール画像のアップロード機能を実装
- バリデーションルールを追加
- UIコンポーネントを新規作成

Closes #123
```

```
fix: USB接続時のタイムアウトエラーを修正

デバイス初期化時の待機時間を延長し、
接続の安定性を向上させました。
```

## ✅ 品質保証と完了基準

### 作業完了時の品質基準
**CRITICAL**: 以下の品質基準をすべて満たしてから作業完了とみなしてください。
- **CRITICAL**: `cargo check`が警告ゼロ・エラーゼロで通過すること。
- **CRITICAL**: `cargo test`が全テスト成功で通過すること。
- **RECOMMENDED**: `cargo clippy`でコード品質をチェックし、指摘事項を修正すること。
- **RECOMMENDED**: `cargo fmt`でコードフォーマットを統一すること。

### テストとドキュメント
**YOU MUST**: 以下のテストおよびドキュメント要件を遵守してください。
- **IMPORTANT**: ドメインロジックの重要な機能は、必ず単体テストでカバーしてください。
- **IMPORTANT**: 公開APIには、その使用法が明確にわかるドキュメントコメントを記述してください。